{% extends 'core_admin/base.html' %}
{% load static %}

{% block title %}{{ portfolio.nome }} - Portfólio | PONTI Admin{% endblock %}

{% block page_title %}{{ portfolio.nome }}{% endblock %}

{% block breadcrumb %}
<span class="breadcrumb-item">Projetos</span>
<span class="breadcrumb-item"><a href="{% url 'projetos:listar_portfolios' %}">Portfólios</a></span>
<span class="breadcrumb-item">{{ portfolio.codigo }}</span>
{% endblock %}

{% block extra_css %}
<style>
    .status-badge {
        padding: 4px 12px;
        border-radius: var(--radius);
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    
    .progress-mini {
        height: 6px;
        border-radius: 3px;
        background: var(--gray-200);
        overflow: hidden;
    }
    
    .progress-bar-mini {
        background: var(--success);
        height: 100%;
        transition: width 0.3s ease;
    }
</style>
{% endblock %}

{% block content %}
{% csrf_token %}
<!-- Header com ações -->
<div class="flex justify-between items-center mb-6">
    <div>
        <p class="text-gray-600 mt-2">{{ portfolio.descricao }}</p>
    </div>
    <div class="flex gap-2">
        <a href="{% url 'projetos:listar_portfolios' %}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Voltar
        </a>
        <a href="{% url 'projetos:editar_portfolio' portfolio.uuid %}" class="btn btn-primary">
            <i class="fas fa-edit"></i> Editar
        </a>
        <button type="button" class="btn btn-danger" onclick="confirmarExclusao()">
            <i class="fas fa-trash"></i> Excluir
        </button>
    </div>
</div>

<!-- Estatísticas Principais -->
<div class="stats-grid mb-6">
    <div class="stat-card">
        <div class="stat-icon">
            <i class="fas fa-layer-group"></i>
        </div>
        <div class="stat-value">{{ programas.count }}</div>
        <div class="stat-label">Programas</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon">
            <i class="fas fa-project-diagram"></i>
        </div>
        <div class="stat-value">{{ total_projetos }}</div>
        <div class="stat-label">Total de Projetos</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon">
            <i class="fas fa-dollar-sign"></i>
        </div>
        <div class="stat-value">R$ {{ portfolio.orcamento_total|floatformat:0 }}</div>
        <div class="stat-label">Orçamento Total</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon">
            <i class="fas fa-chart-line"></i>
        </div>
        <div class="stat-value">R$ {{ orcamento_consumido|floatformat:0 }}</div>
        <div class="stat-label">Orçamento Consumido</div>
    </div>
</div>

<!-- Programas do Portfólio -->
{% if programas %}
<div class="admin-card mb-6">
    <div class="card-header">
        <h3 class="card-title">
            <i class="fas fa-layer-group"></i>
            Programas ({{ programas.count }})
        </h3>
    </div>
    <div class="card-content">
        <div class="grid grid-cols-2">
            {% for programa in programas %}
            <div class="admin-card">
                <div class="card-content">
                    <div class="flex justify-between items-start mb-4">
                        <h4 class="font-semibold text-gray-900">{{ programa.nome }}</h4>
                        <span class="status-badge status-{{ programa.status }}">
                            {{ programa.get_status_display }}
                        </span>
                    </div>
                    
                    <p class="text-gray-600 text-sm mb-4">{{ programa.descricao|truncatewords:15 }}</p>
                    
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-500">
                            {{ programa.projetos.count }} projeto{{ programa.projetos.count|pluralize }}
                        </span>
                        <a href="{% url 'projetos:detalhar_programa' programa.uuid %}" class="btn btn-sm btn-primary">
                            Ver Detalhes
                        </a>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}

<!-- Projetos Diretos -->
{% if projetos_diretos %}
<div class="admin-card mb-6">
    <div class="card-header">
        <h3 class="card-title">
            <i class="fas fa-project-diagram"></i>
            Projetos Diretos ({{ projetos_diretos.count }})
        </h3>
    </div>
    <div class="card-content">
        <div class="overflow-x-auto">
            <table class="min-w-full">
                <thead>
                    <tr class="border-b border-gray-200">
                        <th class="text-left py-3 px-4 font-semibold text-gray-700">Projeto</th>
                        <th class="text-left py-3 px-4 font-semibold text-gray-700">Gerente</th>
                        <th class="text-left py-3 px-4 font-semibold text-gray-700">Status</th>
                        <th class="text-left py-3 px-4 font-semibold text-gray-700">Progresso</th>
                        <th class="text-left py-3 px-4 font-semibold text-gray-700">Prazo</th>
                        <th class="text-left py-3 px-4 font-semibold text-gray-700">Ações</th>
                    </tr>
                </thead>
                <tbody>
                    {% for projeto in projetos_diretos %}
                    <tr class="border-b border-gray-100 hover:bg-gray-50">
                        <td class="py-4 px-4">
                            <div>
                                <div class="font-semibold text-gray-900">{{ projeto.nome }}</div>
                                <div class="text-sm text-gray-500">{{ projeto.codigo }}</div>
                            </div>
                        </td>
                        <td class="py-4 px-4">
                            <div class="text-sm">
                                {{ projeto.gerente_projeto.get_full_name|default:projeto.gerente_projeto.username }}
                            </div>
                        </td>
                        <td class="py-4 px-4">
                            <span class="status-badge status-{{ projeto.status }}">
                                {{ projeto.get_status_display }}
                            </span>
                        </td>
                        <td class="py-4 px-4">
                            <div class="flex items-center gap-3">
                                <div class="progress-mini" style="width: 60px;">
                                    <div class="progress-bar-mini" style="width: {{ projeto.percentual_conclusao }}%"></div>
                                </div>
                                <span class="text-sm text-gray-600">{{ projeto.percentual_conclusao }}%</span>
                            </div>
                        </td>
                        <td class="py-4 px-4">
                            <div class="text-sm">{{ projeto.data_fim_prevista|date:"d/m/Y" }}</div>
                        </td>
                        <td class="py-4 px-4">
                            <a href="{% url 'projetos:detalhar_projeto' projeto.uuid %}" class="btn btn-sm btn-primary">
                                <i class="fas fa-eye"></i>
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}

<!-- Informações Detalhadas -->
<div class="grid grid-cols-2">
    <div class="admin-card">
        <div class="card-header">
            <h3 class="card-title">
                <i class="fas fa-info-circle"></i>
                Informações do Portfólio
            </h3>
        </div>
        <div class="card-content">
            <div class="space-y-4">
                <div>
                    <label class="text-sm font-medium text-gray-600">Código</label>
                    <div class="text-gray-900">{{ portfolio.codigo }}</div>
                </div>
                <div>
                    <label class="text-sm font-medium text-gray-600">Status</label>
                    <div>
                        <span class="status-badge status-{{ portfolio.status }}">
                            {{ portfolio.get_status_display }}
                        </span>
                    </div>
                </div>
                <div>
                    <label class="text-sm font-medium text-gray-600">Gestor</label>
                    <div class="text-gray-900">{{ portfolio.gestor_portfolio.get_full_name|default:portfolio.gestor_portfolio.username }}</div>
                </div>
                <div>
                    <label class="text-sm font-medium text-gray-600">Patrocinador</label>
                    <div class="text-gray-900">{{ portfolio.patrocinador.get_full_name|default:portfolio.patrocinador.username }}</div>
                </div>
                <div>
                    <label class="text-sm font-medium text-gray-600">Período</label>
                    <div class="text-gray-900">{{ portfolio.data_inicio|date:"d/m/Y" }} - {{ portfolio.data_fim_prevista|date:"d/m/Y" }}</div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="admin-card">
        <div class="card-header">
            <h3 class="card-title">
                <i class="fas fa-chart-pie"></i>
                Progresso Geral
            </h3>
        </div>
        <div class="card-content">
            <div class="text-center mb-6">
                <div class="text-3xl font-bold text-gray-900 mb-2">{{ portfolio.get_percentual_conclusao|floatformat:1 }}%</div>
                <div class="text-gray-500">Conclusão do Portfólio</div>
            </div>
            
            <div class="space-y-4">
                <div>
                    <div class="flex justify-between text-sm mb-2">
                        <span class="text-gray-600">Orçamento Total</span>
                        <span class="font-semibold">R$ {{ portfolio.orcamento_total|floatformat:0 }}</span>
                    </div>
                </div>
                <div>
                    <div class="flex justify-between text-sm mb-2">
                        <span class="text-gray-600">Orçamento Consumido</span>
                        <span class="font-semibold">R$ {{ orcamento_consumido|floatformat:0 }}</span>
                    </div>
                </div>
                <div>
                    <div class="flex justify-between text-sm mb-2">
                        <span class="text-gray-600">Total de Projetos</span>
                        <span class="font-semibold">{{ total_projetos }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function confirmarExclusao() {
    if (confirm('Tem certeza que deseja excluir este portfólio?\n\nEsta ação não pode ser desfeita e só será possível se não houver programas ou projetos vinculados.')) {
        // Criar formulário para fazer a requisição POST
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{% url "projetos:excluir_portfolio" portfolio.uuid %}';
        
        // Adicionar token CSRF
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
        if (csrfToken) {
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrfmiddlewaretoken';
            csrfInput.value = csrfToken.value;
            form.appendChild(csrfInput);
        } else {
            // Se não houver token CSRF na página, buscar do cookie
            const csrfCookie = document.cookie.split(';').find(row => row.trim().startsWith('csrftoken='));
            if (csrfCookie) {
                const csrfInput = document.createElement('input');
                csrfInput.type = 'hidden';
                csrfInput.name = 'csrfmiddlewaretoken';
                csrfInput.value = csrfCookie.split('=')[1];
                form.appendChild(csrfInput);
            }
        }
        
        document.body.appendChild(form);
        form.submit();
    }
}
</script>
{% endblock %}